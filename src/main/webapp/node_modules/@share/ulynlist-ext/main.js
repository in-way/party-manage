;(function (factory) {
    if (typeof define === "function" && define.amd) {
        // AMD模式
        define(["jquery","artTemplate","ulynlist"], factory);
    } else {
        // 全局模式
        factory(jQuery,template);
    }
}(function($,artTemplate) {
    var tempFunc = $.fn.ulynlist;
    var tablePageBarTemp = $.fn.ulynlistPagination;
    // console.info("页脚",$.fn.ulynlistPagination);
    // console.info("表格",$.fn.ulynlistTable);
    // console.info("表格",tempFunc);
    $.fn.ulynlist = function (options) {
        var $obj = $(this);
        // console.info("options:",options);
        // console.info($(this));
        var func = options.afterTableRender;
        // var loadFilterFun = options.loadFilter;

        options.afterTableRender = function (ulynlistObj,opts) {
            if(func){
                func(ulynlistObj,opts);
            }

            var tdCheckbox =$(".td_checkbox",$obj);
            var thCheckbox =$(".th_checkbox",$obj);
            //我自己扩展的事情
            $("th[field='CHECKED']").addClass("checkBox radioBox-inline").append('<i></i>');
            tdCheckbox.closest(".td_common").addClass("td_has_checkbox");
            tdCheckbox.closest(".td_val").addClass("checkBox radioBox-inline").append('<i></i>');

            tdCheckbox.click(function(){
                if($(this).prop("checked")){
                    $(this).closest("tr").addClass("selectTr");
                }else{
                    $(this).closest("tr").removeClass("selectTr");
                }
            });

            thCheckbox.click(function(){
                if($(this).prop("checked")){
                    tdCheckbox.closest("tr").addClass("selectTr");
                }else{
                    tdCheckbox.closest("tr").removeClass("selectTr");
                }
            });

            $.each(tdCheckbox,function (i,item) {
                if($(item).prop("checked")){
                    $(this).closest("tr").addClass("selectTr");
                }
            });
        };
        // console.info("basePath:",options.basePath);
        options.basePath = options.basePath.substr(0,options.basePath.indexOf('ulynlist'))+'ulynlist-ext';
        // console.info("basePath:",options.basePath);


        /*适配新版的接口字段*/
        // options.tableColumn.loadFilter  = function(data){
        //     if(loadFilterFun){
        //         loadFilterFun(data);
        //     }
        //
        //     console.info("loadFilter的数据：",data);
        //
        //     $.each(data,function(i,item){
        //
        //     })
        // };

        tempFunc.call(this,options);
        // tempFunc(options);
    };
    for(var key in tempFunc){
        $.fn.ulynlist[key] = tempFunc[key];
    }

    $.fn.ulynlistPagination = function (opts) {
        // console.info("ulynlistPagination:",opts);
        var obj = this;
        // console.info($(obj));
        var func = opts.afterPaginationRender;
        opts.afterPaginationRender = function (ulynlistObj,options) {
			options.totalPage = Math.ceil(Number(opts.totalNum)/Number(opts.linesPerPage));
            if (func) {
                func(ulynlistObj,opts);
            }

            options.pageList = [];
            var pageListSize = 9;

            if(options.totalPage>9){
                options.pageList=[];
                if(options.currentPage <=5){
                    for(var pageI =1;pageI <=9;pageI ++){
                        options.pageList.push(pageI);
                    }
                }else{
                    var cur = options.currentPage;
                    var cur2 = options.currentPage;
                    for(var pageI =1;pageI <=5;pageI ++){
                        options.pageList.push(cur-5+pageI);
                    }
                    for(var pageI =1;pageI <=4;pageI ++){
                        options.pageList.push(cur2+pageI);
                    }
                }
            }else{
                options.pageList=[];
                for(var pageI =1;pageI <=options.totalPage;pageI ++){
                    options.pageList.push(pageI);
                }
            }

            // if(options.currentPage <=4){
            //     var limitSize = (pageListSize>=options.totalPage)?options.totalPage:pageListSize;
            //     for(var pageI =1;pageI <=limitSize;pageI ++){
            //         options.pageList.push(pageI);
            //     }
            // }

            // console.info("options:",options);

            // if(options.currentPage >4){
            //     var limitSize = (pageListSize>=options.totalPage)?options.totalPage:pageListSize;
            //     for(var pageI =limitSize-options.currentPage;pageI <=limitSize;pageI ++){
            //         options.pageList.push(pageI);
            //     }
            // }
            var select_page_bar_tpl ='';
            $.each(options.pageList,function(i,item){
                if(item == options.currentPage){
                    select_page_bar_tpl = select_page_bar_tpl+'<span class="page_num active">'+item+'</span>'
                }else{
                    select_page_bar_tpl = select_page_bar_tpl+'<span class="page_num">'+item+'</span>'
                }
            });



            $(".page_num_bar" ,$(obj)).html(select_page_bar_tpl);
            //初始化点击事件
            $(".pagebottonlist .tableBarA", $(obj)).unbind("click").click(function () {
                var page = $(this).attr("page");
                if(page != options.currentPage && page<=options.totalPage && page!=0){
                    if(page<=0){
                        page = 1;
                    }else if(page>options.totalPage){
                        page = options.totalPage;
                    }
                    $(obj).trigger("clickPage", [page]);
                    options.onPageClick && options.onPageClick(page);
                }
            });

            $(".setGoToPage", $(obj)).html(options.currentPage+"/"+options.totalPage).unbind("click").click(function(){
                $(this).toggleClass("setGoToPageActive");
                $(".select_page_bar",$(obj)).toggle();
                if(!$(".select_page_bar", $(obj)).is(":hidden")){
                    $(".select_page_bar .quire_set_val input", $(obj)).focus();
                }
            });

            $(".select_page_bar .page_num",$(obj)).unbind("click").click(function () {
                $(this).addClass("active").siblings("span").removeClass("active");
                $(".setGoToPage", $(obj)).html($(this).text()+"/"+options.totalPage)
                $(obj).trigger("clickPage", [$(this).text()]);
                options.onPageClick && options.onPageClick($(this).text());
            });
            $(".select_page_bar .quire_set_val input", $(obj)).unbind("keydown").keydown(function(e) {
                e = e || event;
                if (e.keyCode == 13) {
                    setpage($(this));
                    // if($(this).val()<=options.totalPage){
                    //     setpage($(this));
                    // }else {
                    //     alert("超出最大页码");
                    // }
                }
            });
            $(".select_page_bar .go_page", $(obj)).unbind("click").click(function () {
                setpage($(".select_page_bar .quire_set_val input", $(obj)));
            });
            function setpage($InputDom) {
                var val = $InputDom.val();
                // var r = /^[0-9]*[1-9][0-9]*$/; //正整数
                // $(obj).trigger("clickPage", [val]);
                // options.onPageClick && options.onPageClick(val);
                if(val<=options.totalPage){
                    var r = /^[0-9]*[1-9][0-9]*$/; //正整数
                    $(obj).trigger("clickPage", [val]);
                    options.onPageClick && options.onPageClick(val);
                }else {
                    alert("超出最大页码");
                }
            }

            //设置每页几条的按钮点击事情
            $(".setLinesPerPage", $(obj)).unbind("keydown").keydown(function(e){
                e = e||event;
                if(e.keyCode==13){
                    var val = $(this).val();
                    var r = /^[0-9]*[1-9][0-9]*$/; //正整数
                    if(r.test(val)){
                        if(Number(val)>10000){
                            //限制10000条最多
                            val = 10000;
                        }
                        $(obj).trigger("setLinesPerPage", [val]);
                        options.onSetLinesPerPageClick && options.onSetLinesPerPageClick(val);
                    }
                }
            });

            //设置每页多少条快速定位
            $(".js-tableBarPageSize", $(obj)).unbind("click").click(function () {
                if(options.extra.linesPerPageEditable && options.totalNum>10){
                    $(this).toggleClass("activeBorder");
                    $(".page_size_bar", $(obj)).toggle();
                    if(!$(".page_size_bar", $(obj)).is(":hidden")){
                        $(".page_size_bar .quire_set_size input", $(obj)).focus();
                    }
                }
            });
            //选择快速定位多少条的操作
            $(".page_size_bar .size_val", $(obj)).unbind("click").click(function () {
                $(".page_size_bar", $(obj)).hide();
                $(this).addClass("active").siblings("span").removeClass("active");
                $(".tableBarPageSize", $(obj)).html($(this).text());

                $(obj).trigger("setLinesPerPage", [$(this).text()]);
                options.onSetLinesPerPageClick && options.onSetLinesPerPageClick($(this).text());
            });
            $(".page_size_bar .quire_set_size input", $(obj)).unbind("keydown").keydown(function(e){
                e = e||event;
                if(e.keyCode==13){
                    setpageSize($(this));
                }
            });
            $(".page_size_bar .set_page_size", $(obj)).unbind("click").click(function () {
                setpageSize($(".page_size_bar .quire_set_size input", $(obj)));
            });
            function setpageSize($InputDom) {
                var val = $InputDom.val();
                var r = /^[0-9]*[1-9][0-9]*$/; //正整数
                if(r.test(val)){
                    if(Number(val)>10000){
                        //限制10000条最多
                        val = 10000;
                    }
                    $(obj).trigger("setLinesPerPage", [val]);
                    options.onSetLinesPerPageClick && options.onSetLinesPerPageClick(val);
                }
            }
        };
        tablePageBarTemp.call(this,opts);
    }

}));